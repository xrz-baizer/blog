事务消息 https://note.youdao.com/web/#/file/recent/note/158D23CB2568452EA492D9EA9CA2162C/

## Redis

### 持久化

有RDB（redis database）AOF（appebd only file）默认开启RDB，如果两者同时开启则优先使用AOF

RDB

rdb是Redis默认的持久化方案。在指定的时间间隔内，执行指定次数的写操作，会将内存中的数据写入到磁盘中。即在指定目录下生成一个dump.rdb文件。Redis重启会通过加载dump.rdb文件恢复数据。

触发RDB快照：
1、在指定的时间间隔内，执行了指定次数的写操作
2、执行save或者是bgsave（异步）命令
3、执行flushall命令，清空数据库所以数据
4、执行shutdown命令，保证服务器正常关闭且不丢失任何数据

优点
1、适合大规模的数据恢复
2、如果业务对数据完整性和一致性要求不高，RDB是很好的选择
缺点
1、数据的完整性和一致性不高，因为RDB可能在最后一次备份是宕机了
2、备份时占用内存，因为Redis在备份时会独立创建一个子进程，将数据写入一到一个临时文件（此时内存中的数据是原来的两倍），最后再将临时文件替换之前的备份文件

AOF

Redis默认不开启，它的出现是为了弥补RDB的不足（数据的不一致性），所以它采用日志的形式来纪录每个写操作，并追加到文件中。Redis重启会根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作

指定更新日志条件
1、#appendfsync always（同步持久化，每次发生数据变化会立刻写入到磁盘中。性能较差，但数据完整性比较好。慢，安全）
2、#appendfsync everysec（官方推荐，每秒异步纪录一次）
3、#appendfsync no（不同步）

触发AOF快照
1、根据配置文件触发，可以是每次执行触发，可以是每秒触发，也可以不同步

优点
1、数据的完整性和一致性更高

缺点
1、因为AOF纪录的内容多，文件会越来越大，数据恢复也会越来越慢

### 总结

Redis 默认开启RDB持久化方式，在指定的时间间隔内，执行指定次数的写操作，则将内存中的数据写入到磁盘中。
RDB 持久化适合大规模的数据恢复但它的数据一致性和完整性较差。
Redis 需要手动开启AOF持久化方式，默认是每秒将写操作日志追加到AOF文件中。
AOF 的数据完整性比RDB高，但记录内容多了，会影响数据恢复的效率。
Redis 针对 AOF文件大的问题，提供重写的瘦身机制。
若只打算用Redis 做缓存，可以关闭持久化。
若打算使用Redis 的持久化。建议RDB和AOF都开启。其实RDB更适合做数据的备份，留一后手。AOF出问题了，还有RDB。